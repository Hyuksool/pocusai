import { GoogleGenAI, Content, Part } from "@google/genai";
import { Message, PocusMode } from "../types";
import { SYSTEM_INSTRUCTION_TEMPLATE, SUPPORTED_LANGUAGES } from "../constants";

export const sendMessageToGemini = async (
  history: Message[],
  newMessage: string,
  image: string | undefined,
  languageCode: string,
  mode: PocusMode
): Promise<string> => {
  try {
    // Vite 빌드 시 주입되는 process.env.API_KEY 참조
    const apiKey = process.env.API_KEY;
    
    if (!apiKey || apiKey === "undefined" || apiKey === "") {
      throw new Error("API_KEY가 설정되지 않았습니다. Vercel 환경 변수를 확인하세요.");
    }

    const ai = new GoogleGenAI({ apiKey });
    const languageConfig = SUPPORTED_LANGUAGES.find(l => l.code === languageCode) || SUPPORTED_LANGUAGES[0];
    const modeString = mode === 'adult' ? 'Adult' : 'Pediatric';

    let systemInstruction = SYSTEM_INSTRUCTION_TEMPLATE
      .replace(/{LANGUAGE}/g, languageConfig.aiParam)
      .replace(/{MODE}/g, modeString);

    const historyContents: Content[] = history
      .filter((msg) => !msg.isError)
      .map((msg) => {
        const parts: Part[] = [];
        if (msg.image) {
          const mimeMatch = msg.image.match(/^data:(.+);base64,(.+)$/);
          if (mimeMatch) {
            parts.push({
              inlineData: {
                mimeType: mimeMatch[1],
                data: mimeMatch[2]
              }
            });
          }
        }
        if (msg.text) {
          parts.push({ text: msg.text });
        }
        return {
          role: msg.role,
          parts: parts
        };
      });

    let promptText = newMessage;
    if (image) {
       promptText += "\n\n[SYSTEM REQUEST]: Analyze this image using 'Hybrid Intelligence Mode'.";
    }

    const currentParts: Part[] = [{ text: promptText }];
    if (image) {
       const mimeMatch = image.match(/^data:(.+);base64,(.+)$/);
       if (mimeMatch) {
         currentParts.unshift({
           inlineData: {
             mimeType: mimeMatch[1],
             data: mimeMatch[2]
           }
         });
       }
    }

    const response = await ai.models.generateContent({
      model: "gemini-3-flash-preview",
      contents: [...historyContents.slice(0, -1), { role: 'user', parts: currentParts }],
      config: {
        systemInstruction: systemInstruction,
        temperature: 0.1,
      },
    });
    
    return response.text || "결과를 생성할 수 없습니다.";

  } catch (error) {
    console.error("Gemini Error:", error);
    throw new Error(error instanceof Error ? error.message : "에러가 발생했습니다.");
  }
};
